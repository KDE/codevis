stages:
    - build

variables:
    DEPENDENCIES_TAG_BRANCH: $CI_REGISTRY_IMAGE/dependencies:$CI_COMMIT_REF_SLUG
    DEPENDENCIES_TAG_MASTER: $CI_REGISTRY_IMAGE/dependencies:master
    APPIMAGE_TAG_BRANCH: $CI_REGISTRY_IMAGE/appimage:$CI_COMMIT_REF_SLUG
    APPIMAGE_TAG_MASTER: $CI_REGISTRY_IMAGE/appimage:master
    CENTOS_TAG_MASTER: $CI_REGISTRY_IMAGE/centos:master

build-linux job:
    image: "docker:20.10.22"
    services: ["docker:20.10.22-dind"]
    stage: build
    variables:
        OUTDIR: $CI_PROJECT_DIR/generated-diagrams
    before_script:
        - docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY
    script:
        - export DOCKER_BUILDKIT=1
        - docker build -f packaging/appimage/Dockerfile .
            --target dependencies
            --build-arg BUILDKIT_INLINE_CACHE=1
            --cache-from $DEPENDENCIES_TAG_BRANCH
            --cache-from $DEPENDENCIES_TAG_MASTER
            -t $DEPENDENCIES_TAG_BRANCH
        - docker push $DEPENDENCIES_TAG_BRANCH
        - docker build -f packaging/appimage/Dockerfile . --target pre-analysis
        - docker build -f packaging/appimage/Dockerfile . --target build-qt
        - docker build -f packaging/appimage/Dockerfile . --target tests
